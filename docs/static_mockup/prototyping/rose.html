<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Merge Sort Visualizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #0a0a0a;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    
    .tree-node {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tree-node:hover {
      transform: scale(1.05);
    }
    
    .timeline-segment {
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .timeline-segment:hover {
      opacity: 0.8;
    }
    
    .scrubber {
      cursor: ew-resize;
      user-select: none;
    }
  </style>
</head>
<body>
  <div style="display: flex; flex-direction: column; height: 100vh;">
    
    <!-- TIMELINE + CONTROLS -->
    <div style="height: 90px; background: #111; border-bottom: 1px solid #333; padding: 12px 20px; flex-shrink: 0;">
      
      <!-- Timeline Bar -->
      <div style="margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 6px;">
          <span style="font-size: 11px; color: #888; font-weight: 600; text-transform: uppercase;">Timeline</span>
          <div style="flex: 1; height: 32px; background: #1a1a1a; border-radius: 6px; position: relative; overflow: hidden;" id="timeline-container">
            <!-- Segments drawn here -->
          </div>
        </div>
      </div>
      
      <!-- Controls -->
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <button id="btn-reset" style="padding: 6px 12px; background: #222; border: 1px solid #444; border-radius: 4px; color: #aaa; font-size: 12px; cursor: pointer;">Reset</button>
          <button id="btn-prev" style="padding: 6px 10px; background: #222; border: 1px solid #444; border-radius: 4px; color: #aaa; font-size: 12px; cursor: pointer;">â—„</button>
          <button id="btn-play" style="padding: 6px 16px; background: #3b82f6; border: none; border-radius: 4px; color: white; font-size: 12px; font-weight: 600; cursor: pointer;">Play</button>
          <button id="btn-next" style="padding: 6px 10px; background: #222; border: 1px solid #444; border-radius: 4px; color: #aaa; font-size: 12px; cursor: pointer;">â–º</button>
        </div>
        
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="font-size: 11px; color: #666;">Speed:</span>
            <select id="speed-select" style="background: #222; border: 1px solid #444; color: #aaa; font-size: 11px; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
              <option value="2000">0.5x</option>
              <option value="1000" selected>1x</option>
              <option value="500">2x</option>
              <option value="250">4x</option>
            </select>
          </div>
          <div style="font-size: 12px; color: #888; font-family: 'Courier New', monospace;">
            Step <span id="step-display" style="color: #fff; font-weight: 600;">1</span> / <span id="total-display">0</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- MAIN CONTENT AREA -->
    <div style="flex: 1; display: flex; overflow: hidden;">
      
      <!-- LEFT: TREE STRUCTURE -->
      <div style="width: 280px; background: #0d0d0d; border-right: 1px solid #333; overflow-y: auto; padding: 16px; flex-shrink: 0;" id="tree-panel">
        <div style="font-size: 11px; color: #666; font-weight: 600; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px;">Recursion Tree</div>
        <div id="tree-container"></div>
      </div>
      
      <!-- RIGHT: OPERATION DETAIL -->
      <div style="flex: 1; background: #0a0a0a; overflow: hidden; display: flex; align-items: center; justify-content: center; padding: 24px;" id="detail-panel">
        <!-- Content injected here -->
      </div>
      
    </div>
  </div>

  <script>
    // CONFIG
    const INITIAL_ARRAY = [38, 27, 43, 3, 9, 82, 10, 5];
    
    // STATE
    let trace = [];
    let treeStructure = null;
    let currentStep = 0;
    let isPlaying = false;
    let playInterval = null;
    let speed = 1000;
    
    // TRACE GENERATION
    function generateTrace(arr) {
      const steps = [];
      const tree = { children: [] };
      
      function mergeSort(array, depth, parentNode, side) {
        const nodeId = `node-${steps.length}`;
        const node = {
          id: nodeId,
          array: [...array],
          depth,
          side,
          children: [],
          startStep: steps.length,
          endStep: null,
          status: 'pending' // pending, active, complete
        };
        
        if (parentNode) {
          parentNode.children.push(node);
        } else {
          tree.children.push(node);
        }
        
        // SPLIT
        steps.push({
          type: 'SPLIT',
          nodeId,
          array: [...array],
          depth,
          message: depth === 0 ? 'Initial array - begin splitting' : `Split into [${array.join(',')}]`
        });
        
        if (array.length <= 1) {
          node.endStep = steps.length - 1;
          node.status = 'complete';
          return array;
        }
        
        const mid = Math.floor(array.length / 2);
        const left = array.slice(0, mid);
        const right = array.slice(mid);
        
        const sortedLeft = mergeSort(left, depth + 1, node, 'left');
        const sortedRight = mergeSort(right, depth + 1, node, 'right');
        
        // MERGE INIT
        steps.push({
          type: 'MERGE_INIT',
          nodeId,
          left: sortedLeft,
          right: sortedRight,
          depth,
          message: 'Ready to merge sorted subarrays'
        });
        
        // MERGE PROCESS
        let i = 0, j = 0;
        const merged = [];
        
        while (i < sortedLeft.length && j < sortedRight.length) {
          steps.push({
            type: 'COMPARE',
            nodeId,
            left: sortedLeft,
            right: sortedRight,
            leftIdx: i,
            rightIdx: j,
            merged: [...merged],
            depth,
            message: `Compare ${sortedLeft[i]} vs ${sortedRight[j]}`
          });
          
          if (sortedLeft[i] < sortedRight[j]) {
            merged.push(sortedLeft[i]);
            steps.push({
              type: 'SELECT',
              nodeId,
              left: sortedLeft,
              right: sortedRight,
              leftIdx: i,
              rightIdx: j,
              merged: [...merged],
              depth,
              selection: 'left',
              message: `Take ${sortedLeft[i]} from left`
            });
            i++;
          } else {
            merged.push(sortedRight[j]);
            steps.push({
              type: 'SELECT',
              nodeId,
              left: sortedLeft,
              right: sortedRight,
              leftIdx: i,
              rightIdx: j,
              merged: [...merged],
              depth,
              selection: 'right',
              message: `Take ${sortedRight[j]} from right`
            });
            j++;
          }
        }
        
        while (i < sortedLeft.length) {
          merged.push(sortedLeft[i]);
          steps.push({
            type: 'FLUSH_LEFT',
            nodeId,
            left: sortedLeft,
            right: sortedRight,
            leftIdx: i,
            merged: [...merged],
            depth,
            message: `Flush remaining ${sortedLeft[i]} from left`
          });
          i++;
        }
        
        while (j < sortedRight.length) {
          merged.push(sortedRight[j]);
          steps.push({
            type: 'FLUSH_RIGHT',
            nodeId,
            left: sortedLeft,
            right: sortedRight,
            rightIdx: j,
            merged: [...merged],
            depth,
            message: `Flush remaining ${sortedRight[j]} from right`
          });
          j++;
        }
        
        // COMPLETE
        steps.push({
          type: 'COMPLETE',
          nodeId,
          array: [...merged],
          depth,
          message: `Merge complete: [${merged.join(',')}]`
        });
        
        node.endStep = steps.length - 1;
        return merged;
      }
      
      mergeSort(arr, 0, null);
      return { steps, tree };
    }
    
    // RENDER TREE
    function renderTree() {
      const container = document.getElementById('tree-container');
      const step = trace.steps[currentStep];
      
      function renderNode(node, indent = 0) {
        const isActive = node.id === step.nodeId;
        const isComplete = currentStep > node.endStep;
        const isPending = currentStep < node.startStep;
        
        let bgColor = '#1a1a1a';
        let borderColor = '#333';
        let textColor = '#666';
        
        if (isActive) {
          bgColor = '#1e3a8a';
          borderColor = '#3b82f6';
          textColor = '#fff';
        } else if (isComplete) {
          bgColor = '#14532d';
          borderColor = '#22c55e';
          textColor = '#86efac';
        } else if (!isPending) {
          textColor = '#888';
        }
        
        const arrayStr = node.array.join(',');
        const html = `
          <div class="tree-node" data-node-id="${node.id}" style="margin-left: ${indent * 12}px; margin-bottom: 6px; padding: 6px 8px; background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 4px;">
            <div style="font-size: 11px; color: ${textColor}; font-family: 'Courier New', monospace;">[${arrayStr}]</div>
          </div>
        `;
        
        let result = html;
        node.children.forEach(child => {
          result += renderNode(child, indent + 1);
        });
        
        return result;
      }
      
      let html = '';
      treeStructure.children.forEach(root => {
        html += renderNode(root);
      });
      
      container.innerHTML = html;
      
      // Click handlers
      document.querySelectorAll('.tree-node').forEach(el => {
        el.addEventListener('click', () => {
          const nodeId = el.getAttribute('data-node-id');
          const node = findNode(treeStructure, nodeId);
          if (node) {
            jumpToStep(node.startStep);
          }
        });
      });
    }
    
    function findNode(tree, nodeId) {
      function search(node) {
        if (node.id === nodeId) return node;
        for (let child of node.children) {
          const found = search(child);
          if (found) return found;
        }
        return null;
      }
      for (let root of tree.children) {
        const found = search(root);
        if (found) return found;
      }
      return null;
    }
    
    // RENDER TIMELINE
    function renderTimeline() {
      const container = document.getElementById('timeline-container');
      const steps = trace.steps;
      
      let html = '';
      steps.forEach((step, idx) => {
        const width = 100 / steps.length;
        let color = '#444';
        
        if (step.type === 'SPLIT') color = '#3b82f6';
        else if (step.type.includes('MERGE') || step.type.includes('COMPARE') || step.type.includes('SELECT') || step.type.includes('FLUSH')) color = '#a855f7';
        else if (step.type === 'COMPLETE') color = '#22c55e';
        
        const opacity = idx === currentStep ? 1 : (idx < currentStep ? 0.6 : 0.3);
        
        html += `<div class="timeline-segment" data-step="${idx}" style="position: absolute; left: ${idx * width}%; width: ${width}%; height: 100%; background: ${color}; opacity: ${opacity};"></div>`;
      });
      
      container.innerHTML = html;
      
      // Click handlers
      document.querySelectorAll('.timeline-segment').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          const step = parseInt(el.getAttribute('data-step'));
          jumpToStep(step);
        });
      });
      
      // Scrubber
      container.addEventListener('mousedown', (e) => {
        const rect = container.getBoundingClientRect();
        const updateStep = (clientX) => {
          const x = clientX - rect.left;
          const pct = Math.max(0, Math.min(1, x / rect.width));
          const step = Math.floor(pct * steps.length);
          jumpToStep(step);
        };
        
        updateStep(e.clientX);
        
        const onMove = (e) => updateStep(e.clientX);
        const onUp = () => {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        };
        
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    }
    
    // RENDER DETAIL
    function renderDetail() {
      const panel = document.getElementById('detail-panel');
      const step = trace.steps[currentStep];
      
      if (step.type === 'SPLIT') {
        panel.innerHTML = renderSplit(step);
      } else if (step.type === 'MERGE_INIT') {
        panel.innerHTML = renderMergeInit(step);
      } else if (['COMPARE', 'SELECT', 'FLUSH_LEFT', 'FLUSH_RIGHT'].includes(step.type)) {
        panel.innerHTML = renderMergeProcess(step);
      } else if (step.type === 'COMPLETE') {
        panel.innerHTML = renderComplete(step);
      }
    }
    
    function renderSplit(step) {
      const size = Math.max(40, Math.min(60, 400 / step.array.length));
      const squares = step.array.map(n => 
        `<div style="width: ${size}px; height: ${size}px; background: #1e3a8a; border: 2px solid #3b82f6; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: ${size/3}px;">${n}</div>`
      ).join('');
      
      return `
        <div style="max-width: 900px;">
          <div style="text-align: center; margin-bottom: 32px;">
            <div style="display: inline-block; padding: 8px 16px; background: #1e3a8a; border: 1px solid #3b82f6; border-radius: 6px; font-size: 13px; font-weight: 600; color: #93c5fd; margin-bottom: 8px;">SPLIT PHASE</div>
            <div style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 8px;">Dividing Array</div>
            <div style="font-size: 14px; color: #888;">${step.message}</div>
          </div>
          
          <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 24px;">
            ${squares}
          </div>
          
          ${step.array.length > 1 ? `
          <div style="text-align: center;">
            <div style="display: inline-flex; gap: 32px; align-items: center; padding: 16px 32px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px;">
              <div style="text-align: center;">
                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">LEFT</div>
                <div style="font-size: 16px; font-weight: 600; color: #3b82f6;">${Math.ceil(step.array.length / 2)} items</div>
              </div>
              <div style="width: 1px; height: 40px; background: #333;"></div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">RIGHT</div>
                <div style="font-size: 16px; font-weight: 600; color: #3b82f6;">${Math.floor(step.array.length / 2)} items</div>
              </div>
            </div>
          </div>
          ` : '<div style="text-align: center; color: #888; font-size: 14px;">Base case: single element (already sorted)</div>'}
        </div>
      `;
    }
    
    function renderMergeInit(step) {
      const size = 50;
      const leftSq = step.left.map(n => 
        `<div style="width: ${size}px; height: ${size}px; background: #1a1a1a; border: 1px solid #555; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #aaa; font-weight: 600;">${n}</div>`
      ).join('');
      const rightSq = step.right.map(n => 
        `<div style="width: ${size}px; height: ${size}px; background: #1a1a1a; border: 1px solid #555; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #aaa; font-weight: 600;">${n}</div>`
      ).join('');
      
      return `
        <div style="max-width: 1000px;">
          <div style="text-align: center; margin-bottom: 32px;">
            <div style="display: inline-block; padding: 8px 16px; background: #581c87; border: 1px solid #a855f7; border-radius: 6px; font-size: 13px; font-weight: 600; color: #e9d5ff; margin-bottom: 8px;">MERGE PHASE</div>
            <div style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 8px;">Preparing to Merge</div>
            <div style="font-size: 14px; color: #888;">${step.message}</div>
          </div>
          
          <div style="display: flex; gap: 48px; justify-content: center; align-items: center;">
            <div>
              <div style="font-size: 11px; color: #666; margin-bottom: 8px; text-align: center; font-weight: 600;">LEFT SORTED</div>
              <div style="display: flex; gap: 6px;">${leftSq}</div>
            </div>
            
            <div style="font-size: 32px; color: #666;">+</div>
            
            <div>
              <div style="font-size: 11px; color: #666; margin-bottom: 8px; text-align: center; font-weight: 600;">RIGHT SORTED</div>
              <div style="display: flex; gap: 6px;">${rightSq}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderMergeProcess(step) {
      const size = 50;
      const isCompare = step.type === 'COMPARE';
      const isSelect = step.type === 'SELECT';
      
      const leftSq = step.left.map((n, i) => {
        if (i < (step.leftIdx || 0)) return '';
        let bg = '#1a1a1a', border = '#555', color = '#aaa';
        if (i === step.leftIdx) {
          if (isCompare) { bg = '#854d0e'; border = '#fbbf24'; color = '#fff'; }
          else if (isSelect && step.selection === 'left') { bg = '#14532d'; border = '#22c55e'; color = '#fff'; }
        }
        return `<div style="width: ${size}px; height: ${size}px; background: ${bg}; border: 2px solid ${border}; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: ${color}; font-weight: 600; font-size: 18px;">${n}</div>`;
      }).join('');
      
      const rightSq = step.right.map((n, i) => {
        if (i < (step.rightIdx || 0)) return '';
        let bg = '#1a1a1a', border = '#555', color = '#aaa';
        if (i === step.rightIdx) {
          if (isCompare) { bg = '#854d0e'; border = '#fbbf24'; color = '#fff'; }
          else if (isSelect && step.selection === 'right') { bg = '#14532d'; border = '#22c55e'; color = '#fff'; }
        }
        return `<div style="width: ${size}px; height: ${size}px; background: ${bg}; border: 2px solid ${border}; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: ${color}; font-weight: 600; font-size: 18px;">${n}</div>`;
      }).join('');
      
      let comparison = '';
      if (isCompare) {
        const lVal = step.left[step.leftIdx];
        const rVal = step.right[step.rightIdx];
        const result = lVal < rVal;
        comparison = `
          <div style="text-align: center; padding: 16px 24px; background: #1a1a1a; border: 1px solid #444; border-radius: 8px;">
            <div style="font-size: 28px; font-weight: 700; color: #fff; margin-bottom: 8px;">${lVal} < ${rVal}</div>
            <div style="display: inline-block; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; ${result ? 'background: #14532d; color: #22c55e; border: 1px solid #22c55e;' : 'background: #7f1d1d; color: #ef4444; border: 1px solid #ef4444;'}">${result ? 'TRUE' : 'FALSE'}</div>
          </div>
        `;
      }
      
      const mergedSq = step.merged.map(n => 
        `<div style="width: ${size}px; height: ${size}px; background: #14532d; border: 1px solid #22c55e; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #86efac; font-weight: 600; font-size: 18px;">${n}</div>`
      ).join('');
      
      const totalSize = step.left.length + step.right.length;
      const remaining = totalSize - step.merged.length;
      const emptySq = remaining > 0 ? `<div style="width: ${size}px; height: ${size}px; border: 2px dashed #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #444; font-size: 24px;">?</div>` : '';
      
      return `
        <div style="max-width: 1000px;">
          <div style="text-align: center; margin-bottom: 32px;">
            <div style="display: inline-block; padding: 8px 16px; background: #581c87; border: 1px solid #a855f7; border-radius: 6px; font-size: 13px; font-weight: 600; color: #e9d5ff; margin-bottom: 8px;">MERGE PHASE</div>
            <div style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 8px;">Merging Subarrays</div>
            <div style="font-size: 14px; color: #888;">${step.message}</div>
          </div>
          
          <div style="display: flex; gap: 32px; justify-content: center; align-items: center; margin-bottom: 32px;">
            <div>
              <div style="font-size: 11px; color: #666; margin-bottom: 8px; text-align: center; font-weight: 600;">LEFT</div>
              <div style="display: flex; gap: 6px; min-height: ${size}px; align-items: center;">${leftSq || '<span style="color: #444; font-size: 12px;">empty</span>'}</div>
            </div>
            
            ${comparison}
            
            <div>
              <div style="font-size: 11px; color: #666; margin-bottom: 8px; text-align: center; font-weight: 600;">RIGHT</div>
              <div style="display: flex; gap: 6px; min-height: ${size}px; align-items: center;">${rightSq || '<span style="color: #444; font-size: 12px;">empty</span>'}</div>
            </div>
          </div>
          
          <div style="text-align: center;">
            <div style="font-size: 11px; color: #22c55e; margin-bottom: 8px; font-weight: 600;">RESULT</div>
            <div style="display: inline-flex; gap: 6px; padding: 12px; background: #0d0d0d; border: 1px solid #333; border-radius: 8px;">
              ${mergedSq}
              ${emptySq}
            </div>
          </div>
        </div>
      `;
    }
    
    function renderComplete(step) {
      const size = Math.max(40, Math.min(60, 500 / step.array.length));
      const squares = step.array.map(n => 
        `<div style="width: ${size}px; height: ${size}px; background: #14532d; border: 2px solid #22c55e; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #86efac; font-weight: 600; font-size: ${size/3}px;">${n}</div>`
      ).join('');
      
      return `
        <div style="max-width: 900px;">
          <div style="text-align: center; margin-bottom: 32px;">
            <div style="display: inline-block; padding: 8px 16px; background: #14532d; border: 1px solid #22c55e; border-radius: 6px; font-size: 13px; font-weight: 600; color: #86efac; margin-bottom: 8px;">COMPLETE</div>
            <div style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 8px;">Subarray Sorted</div>
            <div style="font-size: 14px; color: #888;">${step.message}</div>
          </div>
          
          <div style="display: flex; gap: 8px; justify-content: center;">
            ${squares}
          </div>
          
          <div style="text-align: center; margin-top: 24px; color: #666; font-size: 13px;">
            ${step.depth === 0 ? 'ðŸŽ‰ Algorithm complete! Array is fully sorted.' : 'Returning to parent level...'}
          </div>
        </div>
      `;
    }
    
    // CONTROLS
    function jumpToStep(step) {
      pause();
      currentStep = Math.max(0, Math.min(trace.steps.length - 1, step));
      render();
    }
    
    function stepForward() {
      if (currentStep < trace.steps.length - 1) {
        currentStep++;
        render();
      } else {
        pause();
      }
    }
    
    function stepBackward() {
      if (currentStep > 0) {
        currentStep--;
        render();
      }
    }
    
    function play() {
      if (currentStep >= trace.steps.length - 1) {
        currentStep = 0;
      }
      isPlaying = true;
      document.getElementById('btn-play').textContent = 'Pause';
      document.getElementById('btn-play').style.background = '#ef4444';
      
      playInterval = setInterval(() => {
        if (currentStep < trace.steps.length - 1) {
          stepForward();
        } else {
          pause();
        }
      }, speed);
    }
    
    function pause() {
      isPlaying = false;
      clearInterval(playInterval);
      document.getElementById('btn-play').textContent = 'Play';
      document.getElementById('btn-play').style.background = '#3b82f6';
    }
    
    function togglePlay() {
      if (isPlaying) {
        pause();
      } else {
        play();
      }
    }
    
    function reset() {
      pause();
      currentStep = 0;
      render();
    }
    
    function render() {
      document.getElementById('step-display').textContent = currentStep + 1;
      document.getElementById('total-display').textContent = trace.steps.length;
      renderTimeline();
      renderTree();
      renderDetail();
    }
    
    // EVENT LISTENERS
    document.getElementById('btn-reset').addEventListener('click', reset);
    document.getElementById('btn-prev').addEventListener('click', stepBackward);
    document.getElementById('btn-play').addEventListener('click', togglePlay);
    document.getElementById('btn-next').addEventListener('click', stepForward);
    document.getElementById('speed-select').addEventListener('change', (e) => {
      speed = parseInt(e.target.value);
      if (isPlaying) {
        pause();
        play();
      }
    });
    
    // KEYBOARD SHORTCUTS
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        togglePlay();
      } else if (e.code === 'ArrowLeft') {
        e.preventDefault();
        stepBackward();
      } else if (e.code === 'ArrowRight') {
        e.preventDefault();
        stepForward();
      } else if (e.code === 'ArrowUp') {
        e.preventDefault();
        const select = document.getElementById('speed-select');
        const idx = select.selectedIndex;
        if (idx > 0) select.selectedIndex = idx - 1;
        speed = parseInt(select.value);
        if (isPlaying) { pause(); play(); }
      } else if (e.code === 'ArrowDown') {
        e.preventDefault();
        const select = document.getElementById('speed-select');
        const idx = select.selectedIndex;
        if (idx < select.options.length - 1) select.selectedIndex = idx + 1;
        speed = parseInt(select.value);
        if (isPlaying) { pause(); play(); }
      }
    });
    
    // INIT
    const result = generateTrace(INITIAL_ARRAY);
    trace = result;
    treeStructure = result.tree;
    render();
  </script>
</body>
</html>